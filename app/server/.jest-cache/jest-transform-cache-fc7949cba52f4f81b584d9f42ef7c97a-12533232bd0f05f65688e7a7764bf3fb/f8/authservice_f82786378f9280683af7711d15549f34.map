{"file":"C:\\Users\\Joseph\\Desktop\\Source\\User_Management_App\\app\\server\\src\\services\\auth.service.ts","mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA,8CAAmD;AACnD,yEAA+D;AAC/D,+CAAiC;AACjC,wDAA8C;AAG9C,yDAA+C;AAE/C,uFAAkF;AAClF,uFAAkF;AAClF,qDAAkE;AAIlE,mFAA8E;AAC9E,uFAAkF;AAClF,qFAAgF;AAChF,oFAA0E;AAC1E,4EAAmE;AACnE,0FAAgF;AAChF,qEAAiE;AACjE,yEAAoE;AACpE,uFAAkF;AAClF,+CAAoE;AACpE,+DAA2D;AAC3D,8DAA0D;AAG1D,0EAA2C;AAC3C,0EAA2C;AAC3C,6DAAyD;AACzD,2EAAsE;AACtE,iFAA2E;AAC3E,8DAAyD;AACzD,6FAAwF;AAGjF,IAAM,WAAW,GAAjB,MAAM,WAAW;IAkBb,KAAK,CAAC,KAAK,CAAC,WAAgC,EAAE,GAAY;QAC7D,MAAM,EAAE,KAAK,EAAE,QAAQ,EAAE,GAAG,WAAW,CAAC;QACxC,OAAO,CAAC,GAAG,CAAC,+BAA+B,EAAE,KAAK,CAAC,CAAC;QACpD,OAAO,CAAC,GAAG,CAAC,kCAAkC,EAAE,QAAQ,CAAC,CAAC;QAE1D,MAAM,IAAI,GAAI,MAAM,IAAI,CAAC,cAAc,CAAC,WAAW,CAAC,KAAK,CAAC,CAAC;QAC3D,OAAO,CAAC,GAAG,CAAC,wBAAwB,EAAE,IAAI,CAAC,CAAC;QAC5C,IAAG,IAAI,KAAK,IAAI,EAAC,CAAC;YACd,OAAO,IAAI,oCAAa,CAAC,GAAG,EAAC,sBAAsB,CAAC,CAAC;QACzD,CAAC;QACD,IAAG,IAAI,CAAC,SAAS,KAAK,KAAK,EAAC,CAAC;YAEzB,MAAM,IAAI,yCAAkB,CAAC,0DAA0D,GAAG,IAAI,CAAC,KAAK,CAAC,CAAC;QAC1G,CAAC;QAED,IAAI,IAAI,IAAK,MAAM,MAAM,CAAC,OAAO,CAAC,QAAQ,EAAC,IAAI,CAAC,QAAQ,CAAC,EAAE,CAAC;YAExD,MAAM,OAAO,GAAwB,IAAA,yCAAgB,EAAC,IAAI,CAAC,CAAC;YAE5D,MAAM,WAAW,GAAY,IAAI,CAAC,qBAAqB,CAAC,mBAAmB,CAAC,OAAO,CAAC,CAAC;YACrF,MAAM,YAAY,GAAY,IAAI,CAAC,qBAAqB,CAAC,oBAAoB,CAAC,OAAO,CAAC,CAAC;YACnF,yCAAyC;YAC7C,OAAO,CAAC,GAAG,CAAC,cAAc,GAAG,GAAG,CAAC,IAAI,CAAC,CAAC;YACvC,IAAI,CAAC,oBAAoB,CAAC,SAAS,CAAC,GAAG,EAAE,IAAA,gDAAmB,EAAC,IAAI,CAAC,EAAE,CAAC,CAAC,CAAC;YACvE,IAAI,CAAC,oBAAoB,CAAC,OAAO,CAAC,GAAG,EAAE,IAAA,gDAAmB,EAAC,IAAI,CAAC,EAAE,CAAC,EAAE,YAAY,CAAC,CAAC;YAEnF,MAAM,SAAS,GAAiB,MAAM,IAAI,CAAC,cAAc,CAAC,YAAY,CAAC,IAAI,CAAC,EAAE,CAAC,CAAC;YAChF,IAAG,SAAS,YAAY,kBAAI,KAAK,KAAK,IAAI,SAAS,KAAK,IAAI,EAAC,CAAC;gBAC1D,wBAAwB;gBACxB,MAAM,OAAO,GAAG,IAAI,kBAAI,EAAE,CAAC;gBAC3B,OAAO,CAAC,IAAI,GAAG,IAAI,CAAC;gBACpB,OAAO,CAAC,YAAY,GAAG,YAAY,CAAC;gBAEpC,IAAI,CAAC,cAAc,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;YACtC,CAAC;iBAAI,CAAC;gBACF,6BAA6B;gBAC7B,SAAS,CAAC,YAAY,GAAG,YAAY,CAAC;gBACtC,MAAM,IAAI,CAAC,cAAc,CAAC,IAAI,CAAC,SAAS,CAAC,CAAC;YAC9C,CAAC;YACD,MAAM,YAAY,GAA0B,EAAE,WAAW,EAAE,WAAW,EAAE,YAAY,EAAE,YAAY,EAAE,CAAC;YACrG,OAAO,YAAY,CAAC;QACxB,CAAC;aAAI,CAAC;YACF,yDAAyD;YACzD,IAAI,CAAC,YAAY,GAAG,IAAI,CAAC,YAAY,GAAI,CAAC,CAAA;YAC1C,IAAG,IAAI,CAAC,YAAY,GAAG,CAAC,EAAC,CAAC;gBAEtB,IAAI,CAAC,SAAS,GAAG,KAAK,CAAC;gBACvB,IAAI,CAAC,MAAM,GAAG,0BAAY,CAAC;gBAC3B,IAAI,CAAC,SAAS,GAAG,IAAI,IAAI,EAAE,CAAC;gBAC5B,MAAM,IAAI,CAAC,cAAc,CAAC,IAAI,CAAC,IAAI,CAAC,CAAA;gBACpC,YAAY;gBACZ,IAAG,OAAO,CAAC,GAAG,CAAC,QAAQ,KAAK,MAAM,EAAC,CAAC;oBAChC,IAAI,SAAS,GAAc,EAAC,QAAQ,EAAG,IAAI,CAAC,QAAQ,EAAE,KAAK,EAAE,IAAI,CAAC,KAAK,EAAC,CAAA;oBACxE,IAAI,CAAC,YAAY,CAAC,SAAS,CAAC,gBAAgB,EAAC,SAAS,CAAE,CAAC;gBAC7D,CAAC;gBAED,gCAAgC;gBAChC,MAAM,aAAa,GAAG,IAAA,sDAAsB,EAAC,GAAG,EAAC,gGAAgG,EAAE,IAAI,CAAC,CAAC;gBACzJ,OAAO,aAAa,CAAC;YAEzB,CAAC;iBAAI,CAAC;gBACF,MAAM,IAAI,CAAC,cAAc,CAAC,IAAI,CAAC,IAAI,CAAC,CAAA;YACxC,CAAC;YACD,MAAM,IAAI,sCAAiB,CAAC,gCAAgC,CAAC,CAAC;QAClE,CAAC;IACL,CAAC;IACD,KAAK,CAAC,MAAM,CAAC,OAA4B;QACrC,MAAM,IAAI,GAAG,MAAM,IAAI,CAAC,cAAc,CAAC,YAAY,CAAC,OAAO,CAAC,IAAI,CAAC,EAAE,CAAC,CAAC;QACrE,IAAG,CAAC,IAAI,EAAC,CAAC;YACN,MAAM,IAAI,gDAAqB,CAAC,2BAA2B,OAAO,CAAC,IAAI,CAAC,EAAE,aAAa,CAAC,CAAC;QAC7F,CAAC;QACD,MAAM,IAAI,CAAC,cAAc,CAAC,MAAM,CAAC,IAAI,CAAC,CAAC;QACvC,MAAM,QAAQ,GAA2B,EAAE,OAAO,EAAE,mBAAmB,EAAE,CAAC;QAC1E,OAAO,QAAQ,CAAC;IACpB,CAAC;IACD,MAAM;QACF,MAAM,IAAI,KAAK,CAAC,yBAAyB,CAAC,CAAC;IAC/C,CAAC;IACD,KAAK;QACD,MAAM,IAAI,KAAK,CAAC,yBAAyB,CAAC,CAAC;IAC/C,CAAC;IACD,KAAK,CAAC,OAAO,CAAC,YAAoB,EAAE,GAAY;QAC5C,wBAAwB;QACxB,MAAM,MAAM,GAAG,IAAI,CAAC,qBAAqB,CAAC,kBAAkB,CAAC,YAAY,CAAC,CAAC;QAE3E,IAAI,CAAC,CAAC,MAAM,YAAY,gCAAiB,CAAC,IAAI,MAAM,YAAY,gCAAiB,EAAE,CAAC;YAChF,OAAO,CAAC,GAAG,CAAC,qCAAqC,EAAE,MAAM,CAAC,OAAO,CAAC,CAAC;YACnE,MAAM,IAAI,sCAAiB,CAAC,yBAAyB,GAAG,MAAM,CAAC,OAAO,CAAC,CAAC;QAC5E,CAAC;QAED,+BAA+B;QAC/B,MAAM,SAAS,GAAG,MAAM,IAAI,CAAC,cAAc,CAAC,kBAAkB,CAAC,YAAY,CAAC,CAAC;QAC7E,OAAO,CAAC,GAAG,CAAC,gCAAgC,EAAE,SAAS,CAAC,CAAC;QACzD,IAAG,CAAC,SAAS,EAAC,CAAC;YACX,MAAM,IAAI,sCAAiB,CAAC,uDAAuD,CAAE,CAAC;QAC1F,CAAC;QACD,IAAG,SAAS,IAAI,MAAM,YAAY,gCAAiB,EAAC,CAAC;YACjD,MAAM,IAAI,CAAC,cAAc,CAAC,MAAM,CAAC,SAAS,CAAC,CAAC;YAC5C,MAAM,IAAI,gCAAc,CAAC,2EAA2E,GAAG,MAAM,CAAC,OAAO,CAAC,CAAC;QAC3H,CAAC;QAED,qBAAqB;QACrB,MAAM,IAAI,GAAG,SAAS,CAAC,IAAI,CAAC;QAC5B,OAAO,CAAC,GAAG,CAAC,uBAAuB,EAAE,IAAI,CAAC,CAAC;QAC3C,MAAM,OAAO,GAAwB,IAAA,yCAAgB,EAAC,IAAI,CAAC,CAAC;QAC5D,MAAM,cAAc,GAAY,IAAI,CAAC,qBAAqB,CAAC,mBAAmB,CAAC,OAAO,CAAC,CAAC;QACxF,MAAM,eAAe,GAAY,IAAI,CAAC,qBAAqB,CAAC,oBAAoB,CAAC,OAAO,CAAC,CAAC;QAC1F,oBAAoB;QACpB,SAAS,CAAC,YAAY,GAAG,eAAe,CAAC;QACzC,MAAM,IAAI,CAAC,cAAc,CAAC,IAAI,CAAC,SAAS,CAAC,CAAC;QAC1C,MAAM,YAAY,GAAiC,EAAE,WAAW,EAAE,cAAc,EAAE,YAAY,EAAE,eAAe,EAAE,CAAC;QAClH,OAAO,YAAY,CAAC;IAExB,CAAC;IACI,KAAK,CAAC,QAAQ,CAAC,WAAmC;QACnD,OAAO,CAAC,GAAG,CAAC,2CAA2C,EAAE,WAAW,CAAC,CAAC;QACtE,IAAG,CAAC;YACA,MAAM,EAAE,QAAQ,EAAE,KAAK,EAAE,QAAQ,EAAE,GAAG,WAAW,CAAC;YAClD,MAAM,oBAAoB,GAAI,MAAM,IAAI,CAAC,cAAc,CAAC,WAAW,CAAC,KAAK,CAAC,CAAC;YAC3E,IAAI,oBAAoB,EAAE,CAAC;gBACvB,MAAM,IAAI,8BAAa,CAAC,sBAAsB,CAAC,CAAC;YACpD,CAAC;YAED,MAAM,uBAAuB,GAAI,MAAM,IAAI,CAAC,cAAc,CAAC,cAAc,CAAC,QAAQ,CAAC,CAAC;YACpF,IAAI,uBAAuB,EAAE,CAAC;gBAC1B,MAAM,IAAI,8BAAa,CAAC,yBAAyB,CAAC,CAAC;YACvD,CAAC;YACD,eAAe;YACf,MAAM,cAAc,GAAY,MAAM,IAAI,CAAC,wBAAwB,CAAC,sBAAsB,CAAC,QAAQ,CAAC,CAAC;YACrG,OAAO,CAAC,GAAG,CAAC,mBAAmB,EAAE,cAAc,CAAC,CAAC;YACjD,sCAAsC;YACtC,WAAW,CAAC,QAAQ,GAAG,cAAc,CAAC;YACtC,MAAM,OAAO,GAAG,IAAI,qBAAI,EAAE,CAAC;YAC3B,oCAAoC;YACpC,MAAM,CAAC,MAAM,CAA+B,OAAO,EAAE,WAAW,CAAC,CAAC;YAClE,OAAO,CAAC,YAAY,GAAG,CAAC,CAAC;YACzB,OAAO,CAAC,SAAS,GAAG,IAAI,CAAC;YACzB,OAAO,CAAC,MAAM,GAAG,2BAAa,CAAA;YAE9B,6CAA6C;YAC7C,MAAM,cAAc,GAAG,8BAAa,CAAC,aAAa,CAAC,qBAAI,CAAC,CAAC;YACzD,IAAI,CAAC,cAAc,EAAE,CAAC;gBAClB,OAAO,CAAC,KAAK,CAAC,mCAAmC,CAAC,CAAC;YACvD,CAAC;YACD,MAAM,YAAY,GAAG,MAAM,cAAc,CAAC,OAAO,CAAC;gBAC9C,KAAK,EAAE,EAAE,IAAI,EAAE,+BAAa,CAAC,IAAI,EAAE;gBACnC,SAAS,EAAE,CAAC,aAAa,CAAC;aAC7B,CAAC,CAAC;YAEH,IAAI,CAAC,YAAY,EAAE,CAAC;gBAChB,MAAM,IAAI,gDAAqB,CAAC,yCAAyC,CAAC,CAAC;YAC/E,CAAC;YAGD,MAAM,WAAW,GAAU,IAAI,CAAC,cAAc,CAAC,MAAM,CAAC;gBAClD,GAAG,OAAO;gBACV,KAAK,EAAE,CAAC,YAAY,CAAC,EAAE,6BAA6B;aACvD,CAAC,CAAC;YAEH,MAAM,SAAS,GAAU,MAAM,IAAI,CAAC,cAAc,CAAC,IAAI,CAAC,WAAW,CAAC,CAAC;YAIrE,OAAO,CAAC,GAAG,CAAC,cAAc,EAAE,SAAS,CAAC,CAAC;YAEvC,MAAM,YAAY,GAA4B;gBAC1C,QAAQ,EAAE,SAAS,CAAC,QAAQ;gBAC5B,KAAK,EAAE,SAAS,CAAC,KAAK;gBACtB,KAAK,EAAE,SAAS,CAAC,KAAK;gBACtB,YAAY,EAAE,SAAS,CAAC,YAAY;gBACpC,SAAS,EAAE,SAAS,CAAC,SAAS;gBAC9B,EAAE,EAAE,SAAS,CAAC,EAAE;gBAChB,SAAS,EAAE,SAAS,CAAC,SAAS;gBAC9B,SAAS,EAAE,SAAS,CAAC,SAAS;gBAC9B,QAAQ,EAAE,SAAS,CAAC,QAAQ;aAC/B,CAAA;YACD,0CAA0C;YAC1C,aAAa;YACb,IAAG,OAAO,CAAC,GAAG,CAAC,QAAQ,KAAK,MAAM,EAAC,CAAC;gBACpC,IAAI,SAAS,GAAc,EAAC,QAAQ,EAAG,YAAY,CAAC,QAAQ,EAAE,KAAK,EAAE,YAAY,CAAC,KAAK,EAAC,CAAA;gBACxF,OAAO,CAAC,GAAG,CAAC,gCAAgC,EAAE,OAAO,CAAC,GAAG,CAAC,OAAO,CAAC,CAAC;gBAEnE,IAAI,CAAC,YAAY,CAAC,SAAS,CAAC,kBAAkB,EAAE,SAAS,CAAC,CAAC;YAC3D,CAAC;YACD,gBAAgB;YAChB,OAAO,YAAY,CAAC;QACxB,CAAC;QAAA,OAAM,CAAU,EAAC,CAAC;YACf,OAAO,CAAC,GAAG,CAAC,yBAAyB,EAAE,CAAC,CAAC,CAAA;YACzC,MAAM,IAAI,2CAAmB,CAAC,kCAAkC,CAAC,CAAC;QACtE,CAAC;IACL,CAAC;CAEJ,CAAA;AAlNY,kCAAW;AAGH;IADhB,IAAA,sBAAS,EAAC,oBAAK,CAAC,uBAAuB,CAAC;kDACN,mDAAuB,oBAAvB,mDAAuB;mDAAC;AAE1C;IADhB,IAAA,sBAAS,EAAC,oBAAK,CAAC,uBAAuB,CAAC;kDACN,mDAAuB,oBAAvB,mDAAuB;mDAAC;AAE1C;IADhB,IAAA,sBAAS,EAAC,oBAAK,CAAC,qBAAqB,CAAC;kDACN,+CAAqB,oBAArB,+CAAqB;iDAAC;AAEtC;IADhB,IAAA,sBAAS,EAAC,oBAAK,CAAC,uBAAuB,CAAC;kDACA,mDAAuB,oBAAvB,mDAAuB;0DAAC;AAEhD;IADhB,IAAA,sBAAS,EAAC,oBAAK,CAAC,uBAAuB,CAAC;kDACA,mDAAuB,oBAAvB,mDAAuB;0DAAC;AAEhD;IADhB,IAAA,sBAAS,EAAC,oBAAK,CAAC,sBAAsB,CAAC;kDACA,iDAAsB,oBAAtB,iDAAsB;yDAAC;AAE9C;IADhB,IAAA,sBAAS,EAAC,oBAAK,CAAC,0BAA0B,CAAC;kDACA,yDAA0B,oBAA1B,yDAA0B;6DAAC;sBAf9D,WAAW;IADvB,IAAA,oBAAO,GAAE;GACG,WAAW,CAkNvB","names":[],"sources":["C:\\Users\\Joseph\\Desktop\\Source\\User_Management_App\\app\\server\\src\\services\\auth.service.ts"],"sourcesContent":["import { AutoWired, Service } from \"../decorators\";\r\nimport { ErrorResponse } from \"../models/error-response.model\";\r\nimport * as bcrypt from \"bcrypt\";\r\nimport { TYPES } from \"../types/binding.type\";\r\nimport { Recipient } from \"../types/recipient.type\";\r\nimport { AuthServiceInterface } from \"../interfaces/auth-service.interface\";\r\nimport { Auth } from \"../entities/auth.entity\";\r\nimport { Request } from \"express\";\r\nimport { AuthRepositoryInterface } from \"../interfaces/auth-repository.interface\";\r\nimport { UserRepositoryInterface } from \"../interfaces/user-repository.interface\";\r\nimport { EnabledStatus, LockedStatus } from \"../data/status.data\";\r\nimport { AuthLoginRequestDTO, AuthRegisterRequestDTO } from \"../dtos/requests/auth-request.dto\";\r\nimport { AuthLoginResponseDTO, AuthLogoutResponseDTO, AuthRefreshTokenResponseDTO, AuthRegisterResponseDTO } from \"../dtos/responses/auth-response.dto\";\r\nimport { JwtPayloadInterface } from \"../interfaces/jwt-payload.interface\";\r\nimport { EmailServiceInterface } from \"../interfaces/email-service.interface\";\r\nimport { TokenGeneratorInterface } from \"../interfaces/token-generator.interface\";\r\nimport { CookieStorageInterface } from \"../interfaces/cookie-storage.interface\";\r\nimport { cookieNameGenerator } from \"../utils/cookie-name-generator.util\";\r\nimport { payloadGenerator } from \"../utils/payload-generator.util\";\r\nimport { errorResponseGenerator } from \"../utils/error-response-generator.util\";\r\nimport { UnAuthorizedError } from \"../errors/unauthorized.error\";\r\nimport { LockedAccountError } from \"../errors/locked-account.error\";\r\nimport { TokenValidatorInterface } from \"../interfaces/token-validator.interface\";\r\nimport { TokenExpiredError, JsonWebTokenError } from \"jsonwebtoken\";\r\nimport { ForbiddenError } from \"../errors/forbidden.error\";\r\nimport { AppDataSource } from \"../configs/typeOrm.config\";\r\nimport { UserCreateRequestDTO } from \"../dtos/requests/user-request.dto\";\r\nimport { UserCreateResponseDTO } from \"../dtos/responses/user-response.dto\";\r\nimport Role from \"../entities/role.entity\";\r\nimport User from \"../entities/user.entity\";\r\nimport { ConflictError } from \"../errors/conflict.error\";\r\nimport { InternalServerError } from \"../errors/internal-server.error\";\r\nimport { ResourceNotFoundError } from \"../errors/resource-not-found.error\";\r\nimport { RoleNamesEnum } from \"../types/role-names.type\";\r\nimport { PasswordGeneratorInterface } from \"../interfaces/password-generator.interface\";\r\n\r\n@Service()\r\nexport class AuthService implements AuthServiceInterface{\r\n\r\n    @AutoWired(TYPES.AuthRepositoryInterface)\r\n    private readonly authRepository!:  AuthRepositoryInterface;\r\n    @AutoWired(TYPES.UserRepositoryInterface)\r\n    private readonly userRepository!:  UserRepositoryInterface;    \r\n    @AutoWired(TYPES.EmailServiceInterface)\r\n    private readonly emailService!:  EmailServiceInterface;\r\n    @AutoWired(TYPES.TokenGeneratorInterface)\r\n    private readonly tokenGeneratorService!: TokenGeneratorInterface;\r\n    @AutoWired(TYPES.TokenValidatorInterface)\r\n    private readonly tokenValidatorService!: TokenValidatorInterface;\r\n    @AutoWired(TYPES.CookieStorageInterface)\r\n    private readonly cookieStorageService!: CookieStorageInterface; \r\n    @AutoWired(TYPES.PasswordGeneratorInterface)\r\n    private readonly passwordGeneratorService!: PasswordGeneratorInterface;\r\n \r\n\r\n    public async login(userRequest: AuthLoginRequestDTO, req: Request): Promise<AuthLoginResponseDTO | ErrorResponse > {\r\n        const { email, password } = userRequest;\r\n        console.log(\"In login service with email: \", email);    \r\n        console.log(\"In login service with password: \", password);\r\n\r\n        const user  = await this.userRepository.findByEmail(email);\r\n        console.log(\"user from repository: \", user);    \r\n        if(user === null){\r\n            return new ErrorResponse(400,\"email does not exist\");\r\n        }\r\n        if(user.isEnabled === false){  \r\n \r\n            throw new LockedAccountError(\"Account is locked, use forget account to access acount: \" + user.email);\r\n        }\r\n\r\n        if (user &&  await bcrypt.compare(password,user.password)) {\r\n\r\n            const payload: JwtPayloadInterface = payloadGenerator(user);          \r\n            \r\n            const accessToken : string = this.tokenGeneratorService.generateAccessToken(payload);\r\n            const refreshToken : string = this.tokenGeneratorService.generateRefreshToken(payload);\r\n                // Access the response object via req.res\r\n            console.log(\"res path is \" + req.path);\r\n            this.cookieStorageService.clearItem(req, cookieNameGenerator(user.id));\r\n            this.cookieStorageService.setItem(req, cookieNameGenerator(user.id), refreshToken);\r\n                                \r\n            const savedAuth : Auth | null = await this.authRepository.findByUserId(user.id);\r\n            if(savedAuth instanceof Auth === false || savedAuth === null){\r\n                //create new auth record\r\n                const newAuth = new Auth();\r\n                newAuth.user = user;\r\n                newAuth.refreshToken = refreshToken;\r\n                \r\n                this.authRepository.save(newAuth);\r\n            }else{\r\n                //update existing auth record\r\n                savedAuth.refreshToken = refreshToken;\r\n                await this.authRepository.save(savedAuth);\r\n            }\r\n            const userResponse : AuthLoginResponseDTO = { accessToken: accessToken, refreshToken: refreshToken };\r\n            return userResponse;\r\n        }else{ \r\n            // handle incorrect password by incrementing failed login\r\n            user.failedLogins = user.failedLogins  + 1      \r\n            if(user.failedLogins > 3){\r\n\r\n                user.isEnabled = false;\r\n                user.status = LockedStatus;\r\n                user.updatedAt = new Date();\r\n                await this.userRepository.save(user)\r\n                //SEND EMAIL\r\n                if(process.env.NODE_ENV !== \"test\"){\r\n                    let recipient : Recipient= {username : user.username, email: user.email}  \r\n                    this.emailService.sendEmail(\"locked-account\",recipient ); \r\n                }\r\n\r\n                // RETURN RESPONSE TO CONTROLLER\r\n                const errorResponse = errorResponseGenerator(400,\"Account is locked because of too many failed login attempts. Use /forgt route to access acount\", user);\r\n                return errorResponse;\r\n\r\n            }else{\r\n                await this.userRepository.save(user)    \r\n            }      \r\n            throw new UnAuthorizedError(\"email or password is incorrect\");\r\n        }              \r\n    }\r\n    async logout(payload: JwtPayloadInterface): Promise<any> {\r\n        const auth = await this.authRepository.findByUserId(payload.user.id);\r\n        if(!auth){\r\n            throw new ResourceNotFoundError(`Auth record for User ID ${payload.user.id} not found.`);\r\n        }\r\n        await this.authRepository.remove(auth);\r\n        const response : AuthLogoutResponseDTO = { message: \"Logout successful\" };\r\n        return response;\r\n    }\r\n    forgot(): Promise<any> {\r\n        throw new Error(\"Method not implemented.\");\r\n    }\r\n    reset(): Promise<any> {\r\n        throw new Error(\"Method not implemented.\");\r\n    }\r\n    async refresh(refreshToken: string, req: Request): Promise<any> {\r\n        //validate refresh token\r\n        const result = this.tokenValidatorService.verifyRefreshToken(refreshToken);\r\n\r\n        if (!(result instanceof TokenExpiredError) && result instanceof JsonWebTokenError) { \r\n            console.log(\"Refresh token verification failed: \", result.message);\r\n            throw new UnAuthorizedError(\"Invalid refresh token: \" + result.message);\r\n        }      \r\n        \r\n        //find auth using refresh token\r\n        const savedAuth = await this.authRepository.findByRefreshToken(refreshToken);\r\n        console.log(\"savedAuth from refresh token: \", savedAuth);   \r\n        if(!savedAuth){\r\n            throw new UnAuthorizedError(\"Invalid refresh token: no matching auth record found.\" );\r\n        }\r\n        if(savedAuth && result instanceof TokenExpiredError){\r\n            await this.authRepository.remove(savedAuth);\r\n            throw new ForbiddenError(\"Refresh token is no longer valid, user must log in to obtain a new token:\" + result.message);   \r\n        }\r\n\r\n        //generate new tokens\r\n        const user = savedAuth.user;\r\n        console.log(\"user from savedAuth: \", user);\r\n        const payload: JwtPayloadInterface = payloadGenerator(user);\r\n        const newAccessToken : string = this.tokenGeneratorService.generateAccessToken(payload);\r\n        const newRefreshToken : string = this.tokenGeneratorService.generateRefreshToken(payload);\r\n        //update auth record\r\n        savedAuth.refreshToken = newRefreshToken;\r\n        await this.authRepository.save(savedAuth);\r\n        const userResponse : AuthRefreshTokenResponseDTO = { accessToken: newAccessToken, refreshToken: newRefreshToken };\r\n        return userResponse;\r\n\r\n    }    \r\n  public async register(userRequest: AuthRegisterRequestDTO): Promise<AuthRegisterResponseDTO | ErrorResponse> {\r\n        console.log(\"In UserService.register with userRequest:\", userRequest);\r\n        try{\r\n            const { username, email, password } = userRequest;\r\n            const userByEmailAvailable  = await this.userRepository.findByEmail(email);\r\n            if (userByEmailAvailable) {\r\n                throw new ConflictError(\"Email already taken!\");\r\n            }\r\n\r\n            const userByUsernameAvailable  = await this.userRepository.findByUsername(username);\r\n            if (userByUsernameAvailable) {\r\n                throw new ConflictError(\"Username already taken!\");\r\n            }\r\n            //Hash password\r\n            const hashedPassword : string = await this.passwordGeneratorService.generateHashedPassword(password);\r\n            console.log(\"Hashed Password: \", hashedPassword);\r\n            //update password with hashed password\r\n            userRequest.password = hashedPassword;\r\n            const newUser = new User();\r\n            //copy properties from DTO to entity\r\n            Object.assign<User, AuthRegisterRequestDTO>(newUser, userRequest);\r\n            newUser.failedLogins = 0;\r\n            newUser.isEnabled = true;\r\n            newUser.status = EnabledStatus\r\n\r\n            // üèÅ Get the repo from the passed dataSource\r\n            const roleRepository = AppDataSource.getRepository(Role);     \r\n            if (!roleRepository) {\r\n                console.error(\"Role repository is not available.\");\r\n            }           \r\n            const existingRole = await roleRepository.findOne({\r\n                where: { name: RoleNamesEnum.USER },\r\n                relations: ['permissions'] \r\n            });\r\n\r\n            if (!existingRole) {\r\n                throw new ResourceNotFoundError(\"Default role not found in the database.\");\r\n            }\r\n\r\n\r\n            const createdUser : User = this.userRepository.create({\r\n                ...newUser,\r\n                roles: [existingRole], // Assign the existing entity\r\n            });\r\n\r\n            const savedUser : User = await this.userRepository.save(createdUser);\r\n\r\n\r\n            \r\n            console.log(\"Saved User: \", savedUser);\r\n            \r\n            const userResponse : AuthRegisterResponseDTO ={\r\n                username: savedUser.username,\r\n                email: savedUser.email,\r\n                phone: savedUser.phone,\r\n                failedLogins: savedUser.failedLogins,\r\n                isEnabled: savedUser.isEnabled,\r\n                id: savedUser.id,\r\n                createdAt: savedUser.createdAt,\r\n                updatedAt: savedUser.updatedAt,\r\n                fullname: savedUser.fullname\r\n            }\r\n            // If in production environment send email\r\n            // SEND EMAIL\r\n            if(process.env.NODE_ENV !== \"test\"){\r\n            let recipient : Recipient= {username : userResponse.username, email: userResponse.email}  \r\n            console.log(\"Sending registration email to:\", process.env.COMPANY);\r\n\r\n            this.emailService.sendEmail('register-account', recipient);\r\n            }\r\n            // SEND RESPONSE\r\n            return userResponse;\r\n        }catch(e: unknown){\r\n            console.log(\"error in service layer \", e)\r\n            throw new InternalServerError(\"internal error in user service !\");\r\n        }\r\n    }    \r\n\r\n}\r\n"],"version":3}