{"file":"C:\\Users\\Joseph\\Desktop\\Source\\User_Management_App\\app\\server\\src\\utils\\authentication.util.ts","mappings":"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","names":[],"sources":["C:\\Users\\Joseph\\Desktop\\Source\\User_Management_App\\app\\server\\src\\utils\\authentication.util.ts"],"sourcesContent":["// src/authentication.ts\r\nimport {Request} from 'express';\r\nimport * as jwt from 'jsonwebtoken';\r\nimport {jwtDecode} from 'jwt-decode';\r\nimport isJwtTokenExpired, { decode } from 'jwt-check-expiry';\r\nimport { JwtPayloadInterface } from '../interfaces/jwt-payload.interface';\r\nimport { Role } from '../entities/role.entity';\r\nimport User from '../entities/user.entity';\r\nimport { AppDataSource } from '../configs/typeOrm.config';\r\nimport { HttpError } from '../errors/http.error';\r\nimport { RBACPermission } from '../types/rbac.type';\r\nimport { RoleNamesEnum } from '../types/role-names.type';\r\nimport AccessControlService from '../services/access-control.service';\r\nimport TokenValidatorService from '../services/token-validator.service';\r\nimport { JsonWebTokenError, TokenExpiredError } from 'jsonwebtoken';\r\nimport { UnAuthorizedError } from '../errors/unauthorized.error';\r\nimport { ForbiddenError } from '../errors/forbidden.error';\r\nimport { isRoleName } from './isRoleName.util';\r\nimport { isRBACPermission } from './isRBACPermission.util';\r\n\r\nexport async function expressAuthentication(\r\n  request: Request,\r\n  securityName: string,\r\n  scopes?: RBACPermission[] | RoleNamesEnum[]\r\n): Promise<any> {\r\n  //get access control instance from ioc container\r\n  const accessControl = new AccessControlService();\r\n  const tokenValidatorService = new TokenValidatorService\r\n\r\n  if (securityName === 'jwt') {\r\n    console.log(\"In expressAuthentication for 'bearer' security scheme\");\r\n    const authHeader = request.headers['authorization'];\r\n    console.log(\"Request headers:\", authHeader);\r\n    const accessToken = authHeader && authHeader.startsWith(\"Bearer\") && authHeader.split(' ')[1]; // Extract the token part after 'Bearer '\r\n\r\n    if (!accessToken) {\r\n      throw new HttpError(401,'No token provided');\r\n    }\r\n\r\n    //validate access token\r\n    const result = tokenValidatorService.verifyAccessToken(accessToken);\r\n\r\n    if ((result instanceof TokenExpiredError) ) { \r\n      console.log(\"Access token verification failed: \", result.message);\r\n      throw new ForbiddenError(\"Access token is no longer valid, user must use valid refresh token or log in to obtain a new token:\" + result.message);   \r\n    }      \r\n\r\n    if(result instanceof JsonWebTokenError){\r\n      console.log(\"Access token verification failed: \", result.message);\r\n      throw new UnAuthorizedError(\"Invalid access token: \" + result.message);   \r\n    }\r\n    const decodedPayload : JwtPayloadInterface = jwtDecode<JwtPayloadInterface>(accessToken);\r\n    console.log(\"decodedPayload = \", decodedPayload);\r\n      const { user : decodedUser } = decodedPayload;\r\n      console.log(\"decoded user from payload: \", decodedUser);  \r\n      //verify scopes/roles if provided\r\n      if (decodedUser) {\r\n        // : Check role directly from token payload\r\n        const userRepository = AppDataSource.getRepository(User); \r\n        const user = await userRepository.findOne({where:{ email: decodedUser.email },            \r\n          relations: {\r\n            status: true,\r\n            roles: {\r\n              permissions: true // This drills down into the Role -> Permission link\r\n            }\r\n          }\r\n        });\r\n\r\n        console.log(\"user in database: \", user)\r\n        if (!user) {\r\n          throw new HttpError(403, \"User not found\");\r\n        }\r\n        accessControl.setUserRoles(user.roles);\r\n        console.log(\"user roles: \", user.roles)\r\n        if(accessControl.isAccountDisabled(user)){\r\n          throw new UnAuthorizedError(\"User account is disabled\");\r\n        }\r\n        if(accessControl.isAccountSuspended(user)){\r\n          throw new UnAuthorizedError(\"User account is suspended\");\r\n        }\r\n        if(accessControl.isAccountLocked(user)){\r\n          throw new UnAuthorizedError(\"User account is locked\");\r\n        }\r\n\r\n        console.log(\"Checking scopes:\", scopes);\r\n        console.log(\"get user permissions from permission class: \", user.getPermissionNames())\r\n\r\n        //if user has full access, grant all permissions\r\n        if(accessControl.hasFullAccess(accessControl.getGrants())){\r\n          console.log(\"user has full access\");\r\n          request.payload = decodedPayload;\r\n          return Promise.resolve(request.payload);        \r\n        }\r\n        if (scopes && scopes.length > 0) {\r\n          let isRoleMatch : boolean = false;\r\n          let hasPermission : boolean = false;        \r\n          for(let scope of scopes){\r\n            console.log(\"checking scope: \", scope);\r\n            if(isRoleName(scope)){\r\n              console.log(\"scopes are role names\");\r\n              isRoleMatch = accessControl.hasRole(scope);\r\n            }\r\n            if(isRBACPermission(scope)){\r\n              console.log(\"scopes are rbac permissions\");\r\n              console.log(\"scope to check permission: \", scope);\r\n              const [resource, action] = scope.split(':');\r\n              console.log(\"resource and action : \", resource,action)\r\n              hasPermission = accessControl.can(action as any, resource as any);              \r\n            }\r\n            \r\n            if (!isRoleMatch && !hasPermission) {\r\n              throw new UnAuthorizedError(`Missing required access: ${scope}`);\r\n            }\r\n\r\n          }\r\n\r\n        }  \r\n        //attached verified user to request payload\r\n        request.payload = decodedPayload;\r\n        return Promise.resolve(request.payload);\r\n      }\r\n      console.log(\"Insufficient permissions to access this resource: no user in token payload\");\r\n      throw new ForbiddenError(\"Insufficient permissions to access this resource\");\r\n  }\r\n  \r\n  throw new HttpError(500, \"Unknown security name\");\r\n\r\n}\r\n\r\n"],"version":3}