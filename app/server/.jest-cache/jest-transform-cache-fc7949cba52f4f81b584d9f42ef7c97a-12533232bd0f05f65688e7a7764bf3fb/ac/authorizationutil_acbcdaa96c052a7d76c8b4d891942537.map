{"file":"C:\\Users\\Joseph\\Desktop\\Source\\User_Management_App\\app\\server\\src\\utils\\authorization.util.ts","mappings":"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","names":[],"sources":["C:\\Users\\Joseph\\Desktop\\Source\\User_Management_App\\app\\server\\src\\utils\\authorization.util.ts"],"sourcesContent":["// src/authentication.ts\r\nimport {Request} from 'express';\r\nimport User from '../entities/user.entity';\r\nimport { AppDataSource } from '../configs/typeOrm.config';\r\nimport { HttpError } from '../errors/http.error';\r\nimport { AuthLoginRequestDTO } from '../dtos/requests/auth-request.dto';\r\nimport { RoleNamesEnum } from '../types/role-names.type';\r\nimport { RBACPermission } from '../types/rbac.type';\r\nimport AccessControlService from '../services/access-control.service';\r\nimport { isRoleName } from './isRoleName.util';\r\nimport { isRBACPermission } from './isRBACPermission.util';\r\nimport { UnAuthorizedError } from '../errors/unauthorized.error';\r\n\r\n\r\nexport async function expressAuthorization(\r\n  request: Request,\r\n  securityName: string,\r\n  scopes?: RBACPermission[] | RoleNamesEnum[]\r\n): Promise<any> {\r\n  //get access control instance from ioc container\r\n  const accessControl = new AccessControlService();\r\n\r\n\r\n  if (request) {\r\n    console.log(\"In express Authorization \");\r\n    console.log(\"security name: \", securityName);\r\n    console.log(\"scopes in util: \", scopes)\r\n    const {email , password} : AuthLoginRequestDTO = request.body;\r\n    console.log(\"email: \",email,\" passowrd: \", password )\r\n    if(!email || !password)\r\n      throw new HttpError(400, \"Missing email or password\");\r\n    try {\r\n      \r\n\r\n\r\n    if (email) {\r\n       // : Check role directly from token payload\r\n\r\n        // : Verify against TypeORM database for real-time security\r\n        const userRepository = AppDataSource.getRepository(User); \r\n        const user = await userRepository.findOne({where:{ email: email },            \r\n           relations: {\r\n                status: true,\r\n                roles: {\r\n                    permissions: true // This drills down into the Role -> Permission link\r\n                }\r\n            }});\r\n\r\n\r\n        console.log(\"user in database: \", user)\r\n        if (!user) {\r\n          throw new HttpError(403, \"User not found\");\r\n        }\r\n        accessControl.setUserRoles(user.roles);\r\n        console.log(\"user roles: \", user.roles)\r\n        if(accessControl.isAccountDisabled(user)){\r\n          throw new UnAuthorizedError(\"User account is disabled\");\r\n        }\r\n        if(accessControl.isAccountSuspended(user)){\r\n          throw new UnAuthorizedError(\"User account is suspended\");\r\n        }\r\n        if(accessControl.isAccountLocked(user)){\r\n          throw new UnAuthorizedError(\"User account is locked\");\r\n        }\r\n\r\n        \r\n        console.log(\"Checking scopes:\", scopes);\r\n        console.log(\"get user permissions from permission class: \", user.getPermissionNames())\r\n\r\n        //if user has full access, grant all permissions\r\n        if(accessControl.hasFullAccess(accessControl.getGrants())){\r\n          console.log(\"user has full access\");\r\n          return Promise.resolve(request.payload);\r\n        }\r\n        if (scopes && scopes.length > 0) {\r\n          let isRoleMatch : boolean = false;\r\n          let hasPermission : boolean = false;        \r\n          for(let scope of scopes){\r\n            console.log(\"checking scope: \", scope);\r\n            if(isRoleName(scope)){\r\n              console.log(\"scopes are role names\");\r\n              isRoleMatch = accessControl.hasRole(scope);\r\n            }\r\n            if(isRBACPermission(scope)){\r\n              console.log(\"scopes are rbac permissions\");\r\n              console.log(\"scope to check permission: \", scope);\r\n              const [resource, action] = scope.split(':');\r\n              console.log(\"resource and action : \", resource,action)\r\n              hasPermission = accessControl.can(action as any, resource as any);\r\n            }\r\n\r\n            \r\n          if (!isRoleMatch && !hasPermission) {\r\n            throw new UnAuthorizedError(`Missing required access: ${scope}`);\r\n          }\r\n\r\n          }\r\n\r\n        }\r\n        console.log(\"payload to return: \", request.payload); \r\n      return Promise.resolve(request.payload);\r\n    } else {\r\n      console.log(\"Token verification failed.\");\r\n      Promise.reject(new HttpError(403, \"Invalid token\"));\r\n    }\r\n    } catch (error : unknown) {\r\n      if (error instanceof HttpError) {\r\n        throw new HttpError(error.statusCode, error.message);\r\n      }\r\n      throw new HttpError(500, \"Unknown error during token verification\");\r\n\r\n    }\r\n  }\r\n    throw new HttpError(500, \"Unknown security name\");\r\n\r\n}\r\n\r\n"],"version":3}